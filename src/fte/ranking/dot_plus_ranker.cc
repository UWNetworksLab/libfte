#include <iostream>

#include "fte/ranking/dot_plus_ranker.h"

#include "ffx/conversions.h"

namespace fte {

namespace ranking {
  
bool DotPlusRanker::SetLanguage(const std::string & dfa, uint32_t max_word_length) {
  max_word_len_ = max_word_length;
}

bool DotPlusRanker::Unrank(const mpz_class & rank,
                           std::string * word) {
  mpz_class c = rank;
  
  uint32_t num_symbols = mpz_sizeinbase(rank.get_mpz_t(), 256);
  
  mpz_class e;
  mpz_ui_pow_ui (e.get_mpz_t(), 256, num_symbols - 1);
  mpz_sub(c.get_mpz_t(), c.get_mpz_t(), e.get_mpz_t());
    
  unsigned char * retval = new unsigned char[num_symbols];
  ffx::MpzClassToBase256(c, num_symbols, retval);
  (*word) = new std::string((char*)retval, num_symbols);
  delete[] retval;
}

bool DotPlusRanker::Rank(const std::string & word,
                         mpz_class * rank) {
  (*rank) = 0;

  mpz_class e;
  mpz_ui_pow_ui(e.get_mpz_t(), 256, word.length() - 1);
  mpz_add(rank->get_mpz_t(), rank->get_mpz_t(), e.get_mpz_t());

  mpz_class in_slice_rank;
  const unsigned char * const_input = reinterpret_cast<const unsigned char *>(word.c_str());
  unsigned char * input = const_cast<unsigned char *>(const_input);
  ffx::Base256ToMpzClass(input, word.length(), &in_slice_rank);
  mpz_add(rank->get_mpz_t(), rank->get_mpz_t(), in_slice_rank.get_mpz_t());
}

bool DotPlusRanker::WordsInLanguage(mpz_class * words_in_language) {
  WordsInLanguage(0, max_word_len_, words_in_language);
}

bool DotPlusRanker::WordsInLanguage(uint32_t max_word_length,
                                    mpz_class * words_in_language) {
  WordsInLanguage(0, max_word_length, words_in_language);
}

bool DotPlusRanker::WordsInLanguage(uint32_t min_word_length,
                                    uint32_t max_word_length,
                                    mpz_class * words_in_language ) {
  mpz_class e;
  for (uint32_t i = min_word_length; i <= max_word_length; ++i) {
    mpz_ui_pow_ui (e.get_mpz_t(), 256, i);
    mpz_add(words_in_language->get_mpz_t(), words_in_language->get_mpz_t(), e.get_mpz_t());
  }
}


std::string DOT_PLUS_DFA = "0	1	0	0\n"
                           "0	1	1	1\n"
                           "0	1	2	2\n"
                           "0	1	3	3\n"
                           "0	1	4	4\n"
                           "0	1	5	5\n"
                           "0	1	6	6\n"
                           "0	1	7	7\n"
                           "0	1	8	8\n"
                           "0	1	9	9\n"
                           "0	1	10	10\n"
                           "0	1	11	11\n"
                           "0	1	12	12\n"
                           "0	1	13	13\n"
                           "0	1	14	14\n"
                           "0	1	15	15\n"
                           "0	1	16	16\n"
                           "0	1	17	17\n"
                           "0	1	18	18\n"
                           "0	1	19	19\n"
                           "0	1	20	20\n"
                           "0	1	21	21\n"
                           "0	1	22	22\n"
                           "0	1	23	23\n"
                           "0	1	24	24\n"
                           "0	1	25	25\n"
                           "0	1	26	26\n"
                           "0	1	27	27\n"
                           "0	1	28	28\n"
                           "0	1	29	29\n"
                           "0	1	30	30\n"
                           "0	1	31	31\n"
                           "0	1	32	32\n"
                           "0	1	33	33\n"
                           "0	1	34	34\n"
                           "0	1	35	35\n"
                           "0	1	36	36\n"
                           "0	1	37	37\n"
                           "0	1	38	38\n"
                           "0	1	39	39\n"
                           "0	1	40	40\n"
                           "0	1	41	41\n"
                           "0	1	42	42\n"
                           "0	1	43	43\n"
                           "0	1	44	44\n"
                           "0	1	45	45\n"
                           "0	1	46	46\n"
                           "0	1	47	47\n"
                           "0	1	48	48\n"
                           "0	1	49	49\n"
                           "0	1	50	50\n"
                           "0	1	51	51\n"
                           "0	1	52	52\n"
                           "0	1	53	53\n"
                           "0	1	54	54\n"
                           "0	1	55	55\n"
                           "0	1	56	56\n"
                           "0	1	57	57\n"
                           "0	1	58	58\n"
                           "0	1	59	59\n"
                           "0	1	60	60\n"
                           "0	1	61	61\n"
                           "0	1	62	62\n"
                           "0	1	63	63\n"
                           "0	1	64	64\n"
                           "0	1	65	65\n"
                           "0	1	66	66\n"
                           "0	1	67	67\n"
                           "0	1	68	68\n"
                           "0	1	69	69\n"
                           "0	1	70	70\n"
                           "0	1	71	71\n"
                           "0	1	72	72\n"
                           "0	1	73	73\n"
                           "0	1	74	74\n"
                           "0	1	75	75\n"
                           "0	1	76	76\n"
                           "0	1	77	77\n"
                           "0	1	78	78\n"
                           "0	1	79	79\n"
                           "0	1	80	80\n"
                           "0	1	81	81\n"
                           "0	1	82	82\n"
                           "0	1	83	83\n"
                           "0	1	84	84\n"
                           "0	1	85	85\n"
                           "0	1	86	86\n"
                           "0	1	87	87\n"
                           "0	1	88	88\n"
                           "0	1	89	89\n"
                           "0	1	90	90\n"
                           "0	1	91	91\n"
                           "0	1	92	92\n"
                           "0	1	93	93\n"
                           "0	1	94	94\n"
                           "0	1	95	95\n"
                           "0	1	96	96\n"
                           "0	1	97	97\n"
                           "0	1	98	98\n"
                           "0	1	99	99\n"
                           "0	1	100	100\n"
                           "0	1	101	101\n"
                           "0	1	102	102\n"
                           "0	1	103	103\n"
                           "0	1	104	104\n"
                           "0	1	105	105\n"
                           "0	1	106	106\n"
                           "0	1	107	107\n"
                           "0	1	108	108\n"
                           "0	1	109	109\n"
                           "0	1	110	110\n"
                           "0	1	111	111\n"
                           "0	1	112	112\n"
                           "0	1	113	113\n"
                           "0	1	114	114\n"
                           "0	1	115	115\n"
                           "0	1	116	116\n"
                           "0	1	117	117\n"
                           "0	1	118	118\n"
                           "0	1	119	119\n"
                           "0	1	120	120\n"
                           "0	1	121	121\n"
                           "0	1	122	122\n"
                           "0	1	123	123\n"
                           "0	1	124	124\n"
                           "0	1	125	125\n"
                           "0	1	126	126\n"
                           "0	1	127	127\n"
                           "0	1	128	128\n"
                           "0	1	129	129\n"
                           "0	1	130	130\n"
                           "0	1	131	131\n"
                           "0	1	132	132\n"
                           "0	1	133	133\n"
                           "0	1	134	134\n"
                           "0	1	135	135\n"
                           "0	1	136	136\n"
                           "0	1	137	137\n"
                           "0	1	138	138\n"
                           "0	1	139	139\n"
                           "0	1	140	140\n"
                           "0	1	141	141\n"
                           "0	1	142	142\n"
                           "0	1	143	143\n"
                           "0	1	144	144\n"
                           "0	1	145	145\n"
                           "0	1	146	146\n"
                           "0	1	147	147\n"
                           "0	1	148	148\n"
                           "0	1	149	149\n"
                           "0	1	150	150\n"
                           "0	1	151	151\n"
                           "0	1	152	152\n"
                           "0	1	153	153\n"
                           "0	1	154	154\n"
                           "0	1	155	155\n"
                           "0	1	156	156\n"
                           "0	1	157	157\n"
                           "0	1	158	158\n"
                           "0	1	159	159\n"
                           "0	1	160	160\n"
                           "0	1	161	161\n"
                           "0	1	162	162\n"
                           "0	1	163	163\n"
                           "0	1	164	164\n"
                           "0	1	165	165\n"
                           "0	1	166	166\n"
                           "0	1	167	167\n"
                           "0	1	168	168\n"
                           "0	1	169	169\n"
                           "0	1	170	170\n"
                           "0	1	171	171\n"
                           "0	1	172	172\n"
                           "0	1	173	173\n"
                           "0	1	174	174\n"
                           "0	1	175	175\n"
                           "0	1	176	176\n"
                           "0	1	177	177\n"
                           "0	1	178	178\n"
                           "0	1	179	179\n"
                           "0	1	180	180\n"
                           "0	1	181	181\n"
                           "0	1	182	182\n"
                           "0	1	183	183\n"
                           "0	1	184	184\n"
                           "0	1	185	185\n"
                           "0	1	186	186\n"
                           "0	1	187	187\n"
                           "0	1	188	188\n"
                           "0	1	189	189\n"
                           "0	1	190	190\n"
                           "0	1	191	191\n"
                           "0	1	192	192\n"
                           "0	1	193	193\n"
                           "0	1	194	194\n"
                           "0	1	195	195\n"
                           "0	1	196	196\n"
                           "0	1	197	197\n"
                           "0	1	198	198\n"
                           "0	1	199	199\n"
                           "0	1	200	200\n"
                           "0	1	201	201\n"
                           "0	1	202	202\n"
                           "0	1	203	203\n"
                           "0	1	204	204\n"
                           "0	1	205	205\n"
                           "0	1	206	206\n"
                           "0	1	207	207\n"
                           "0	1	208	208\n"
                           "0	1	209	209\n"
                           "0	1	210	210\n"
                           "0	1	211	211\n"
                           "0	1	212	212\n"
                           "0	1	213	213\n"
                           "0	1	214	214\n"
                           "0	1	215	215\n"
                           "0	1	216	216\n"
                           "0	1	217	217\n"
                           "0	1	218	218\n"
                           "0	1	219	219\n"
                           "0	1	220	220\n"
                           "0	1	221	221\n"
                           "0	1	222	222\n"
                           "0	1	223	223\n"
                           "0	1	224	224\n"
                           "0	1	225	225\n"
                           "0	1	226	226\n"
                           "0	1	227	227\n"
                           "0	1	228	228\n"
                           "0	1	229	229\n"
                           "0	1	230	230\n"
                           "0	1	231	231\n"
                           "0	1	232	232\n"
                           "0	1	233	233\n"
                           "0	1	234	234\n"
                           "0	1	235	235\n"
                           "0	1	236	236\n"
                           "0	1	237	237\n"
                           "0	1	238	238\n"
                           "0	1	239	239\n"
                           "0	1	240	240\n"
                           "0	1	241	241\n"
                           "0	1	242	242\n"
                           "0	1	243	243\n"
                           "0	1	244	244\n"
                           "0	1	245	245\n"
                           "0	1	246	246\n"
                           "0	1	247	247\n"
                           "0	1	248	248\n"
                           "0	1	249	249\n"
                           "0	1	250	250\n"
                           "0	1	251	251\n"
                           "0	1	252	252\n"
                           "0	1	253	253\n"
                           "0	1	254	254\n"
                           "0	1	255	255\n"
                           "1	1	0	0\n"
                           "1	1	1	1\n"
                           "1	1	2	2\n"
                           "1	1	3	3\n"
                           "1	1	4	4\n"
                           "1	1	5	5\n"
                           "1	1	6	6\n"
                           "1	1	7	7\n"
                           "1	1	8	8\n"
                           "1	1	9	9\n"
                           "1	1	10	10\n"
                           "1	1	11	11\n"
                           "1	1	12	12\n"
                           "1	1	13	13\n"
                           "1	1	14	14\n"
                           "1	1	15	15\n"
                           "1	1	16	16\n"
                           "1	1	17	17\n"
                           "1	1	18	18\n"
                           "1	1	19	19\n"
                           "1	1	20	20\n"
                           "1	1	21	21\n"
                           "1	1	22	22\n"
                           "1	1	23	23\n"
                           "1	1	24	24\n"
                           "1	1	25	25\n"
                           "1	1	26	26\n"
                           "1	1	27	27\n"
                           "1	1	28	28\n"
                           "1	1	29	29\n"
                           "1	1	30	30\n"
                           "1	1	31	31\n"
                           "1	1	32	32\n"
                           "1	1	33	33\n"
                           "1	1	34	34\n"
                           "1	1	35	35\n"
                           "1	1	36	36\n"
                           "1	1	37	37\n"
                           "1	1	38	38\n"
                           "1	1	39	39\n"
                           "1	1	40	40\n"
                           "1	1	41	41\n"
                           "1	1	42	42\n"
                           "1	1	43	43\n"
                           "1	1	44	44\n"
                           "1	1	45	45\n"
                           "1	1	46	46\n"
                           "1	1	47	47\n"
                           "1	1	48	48\n"
                           "1	1	49	49\n"
                           "1	1	50	50\n"
                           "1	1	51	51\n"
                           "1	1	52	52\n"
                           "1	1	53	53\n"
                           "1	1	54	54\n"
                           "1	1	55	55\n"
                           "1	1	56	56\n"
                           "1	1	57	57\n"
                           "1	1	58	58\n"
                           "1	1	59	59\n"
                           "1	1	60	60\n"
                           "1	1	61	61\n"
                           "1	1	62	62\n"
                           "1	1	63	63\n"
                           "1	1	64	64\n"
                           "1	1	65	65\n"
                           "1	1	66	66\n"
                           "1	1	67	67\n"
                           "1	1	68	68\n"
                           "1	1	69	69\n"
                           "1	1	70	70\n"
                           "1	1	71	71\n"
                           "1	1	72	72\n"
                           "1	1	73	73\n"
                           "1	1	74	74\n"
                           "1	1	75	75\n"
                           "1	1	76	76\n"
                           "1	1	77	77\n"
                           "1	1	78	78\n"
                           "1	1	79	79\n"
                           "1	1	80	80\n"
                           "1	1	81	81\n"
                           "1	1	82	82\n"
                           "1	1	83	83\n"
                           "1	1	84	84\n"
                           "1	1	85	85\n"
                           "1	1	86	86\n"
                           "1	1	87	87\n"
                           "1	1	88	88\n"
                           "1	1	89	89\n"
                           "1	1	90	90\n"
                           "1	1	91	91\n"
                           "1	1	92	92\n"
                           "1	1	93	93\n"
                           "1	1	94	94\n"
                           "1	1	95	95\n"
                           "1	1	96	96\n"
                           "1	1	97	97\n"
                           "1	1	98	98\n"
                           "1	1	99	99\n"
                           "1	1	100	100\n"
                           "1	1	101	101\n"
                           "1	1	102	102\n"
                           "1	1	103	103\n"
                           "1	1	104	104\n"
                           "1	1	105	105\n"
                           "1	1	106	106\n"
                           "1	1	107	107\n"
                           "1	1	108	108\n"
                           "1	1	109	109\n"
                           "1	1	110	110\n"
                           "1	1	111	111\n"
                           "1	1	112	112\n"
                           "1	1	113	113\n"
                           "1	1	114	114\n"
                           "1	1	115	115\n"
                           "1	1	116	116\n"
                           "1	1	117	117\n"
                           "1	1	118	118\n"
                           "1	1	119	119\n"
                           "1	1	120	120\n"
                           "1	1	121	121\n"
                           "1	1	122	122\n"
                           "1	1	123	123\n"
                           "1	1	124	124\n"
                           "1	1	125	125\n"
                           "1	1	126	126\n"
                           "1	1	127	127\n"
                           "1	1	128	128\n"
                           "1	1	129	129\n"
                           "1	1	130	130\n"
                           "1	1	131	131\n"
                           "1	1	132	132\n"
                           "1	1	133	133\n"
                           "1	1	134	134\n"
                           "1	1	135	135\n"
                           "1	1	136	136\n"
                           "1	1	137	137\n"
                           "1	1	138	138\n"
                           "1	1	139	139\n"
                           "1	1	140	140\n"
                           "1	1	141	141\n"
                           "1	1	142	142\n"
                           "1	1	143	143\n"
                           "1	1	144	144\n"
                           "1	1	145	145\n"
                           "1	1	146	146\n"
                           "1	1	147	147\n"
                           "1	1	148	148\n"
                           "1	1	149	149\n"
                           "1	1	150	150\n"
                           "1	1	151	151\n"
                           "1	1	152	152\n"
                           "1	1	153	153\n"
                           "1	1	154	154\n"
                           "1	1	155	155\n"
                           "1	1	156	156\n"
                           "1	1	157	157\n"
                           "1	1	158	158\n"
                           "1	1	159	159\n"
                           "1	1	160	160\n"
                           "1	1	161	161\n"
                           "1	1	162	162\n"
                           "1	1	163	163\n"
                           "1	1	164	164\n"
                           "1	1	165	165\n"
                           "1	1	166	166\n"
                           "1	1	167	167\n"
                           "1	1	168	168\n"
                           "1	1	169	169\n"
                           "1	1	170	170\n"
                           "1	1	171	171\n"
                           "1	1	172	172\n"
                           "1	1	173	173\n"
                           "1	1	174	174\n"
                           "1	1	175	175\n"
                           "1	1	176	176\n"
                           "1	1	177	177\n"
                           "1	1	178	178\n"
                           "1	1	179	179\n"
                           "1	1	180	180\n"
                           "1	1	181	181\n"
                           "1	1	182	182\n"
                           "1	1	183	183\n"
                           "1	1	184	184\n"
                           "1	1	185	185\n"
                           "1	1	186	186\n"
                           "1	1	187	187\n"
                           "1	1	188	188\n"
                           "1	1	189	189\n"
                           "1	1	190	190\n"
                           "1	1	191	191\n"
                           "1	1	192	192\n"
                           "1	1	193	193\n"
                           "1	1	194	194\n"
                           "1	1	195	195\n"
                           "1	1	196	196\n"
                           "1	1	197	197\n"
                           "1	1	198	198\n"
                           "1	1	199	199\n"
                           "1	1	200	200\n"
                           "1	1	201	201\n"
                           "1	1	202	202\n"
                           "1	1	203	203\n"
                           "1	1	204	204\n"
                           "1	1	205	205\n"
                           "1	1	206	206\n"
                           "1	1	207	207\n"
                           "1	1	208	208\n"
                           "1	1	209	209\n"
                           "1	1	210	210\n"
                           "1	1	211	211\n"
                           "1	1	212	212\n"
                           "1	1	213	213\n"
                           "1	1	214	214\n"
                           "1	1	215	215\n"
                           "1	1	216	216\n"
                           "1	1	217	217\n"
                           "1	1	218	218\n"
                           "1	1	219	219\n"
                           "1	1	220	220\n"
                           "1	1	221	221\n"
                           "1	1	222	222\n"
                           "1	1	223	223\n"
                           "1	1	224	224\n"
                           "1	1	225	225\n"
                           "1	1	226	226\n"
                           "1	1	227	227\n"
                           "1	1	228	228\n"
                           "1	1	229	229\n"
                           "1	1	230	230\n"
                           "1	1	231	231\n"
                           "1	1	232	232\n"
                           "1	1	233	233\n"
                           "1	1	234	234\n"
                           "1	1	235	235\n"
                           "1	1	236	236\n"
                           "1	1	237	237\n"
                           "1	1	238	238\n"
                           "1	1	239	239\n"
                           "1	1	240	240\n"
                           "1	1	241	241\n"
                           "1	1	242	242\n"
                           "1	1	243	243\n"
                           "1	1	244	244\n"
                           "1	1	245	245\n"
                           "1	1	246	246\n"
                           "1	1	247	247\n"
                           "1	1	248	248\n"
                           "1	1	249	249\n"
                           "1	1	250	250\n"
                           "1	1	251	251\n"
                           "1	1	252	252\n"
                           "1	1	253	253\n"
                           "1	1	254	254\n"
                           "1	1	255	255\n"
                           "1\n";

}

}
